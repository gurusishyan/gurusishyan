# version: 2.1
# jobs:
#   build:
#     working_directory: ~/public
#     docker:
#       - image: circleci/node:10.15.3
#     steps:
#       - checkout
#       - run:
#           name: update-npm
#           command: 'sudo npm install -g npm@latest'
#       - restore_cache:
#           key: dependency-cache-{{checksum "package.json"}}
#       - run:
#           name: install-npm
#           command: npm install
#       - save_cache:
#           key: dependency-cache-{{checksum "package.json"}}
#           paths:
#             - ./node_modules
#       - run:
#           name: test
#           command: npm run test
#       - store_artifacts:
#           path: test-results.xml
#           prefix: tests
#       - store_artifacts:
#           path: coverage
#           prefix: coverage
#       - store_test_results:
#           path: test-results.xml

# Javascript Node CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-javascript/ for more details
#
version: 2
  jobs:
    build:
      branches:
        only:
          - develop
        docker:
          # specify the version you desire here
          - image: circleci/node:8.0
          - image: docker:17.09.1-ce-git  # enable the docker build support
       working_directory: 
         steps:
           - checkout
           - setup_remote_docker
           -  run:
                name: update-npm
                command: 'sudo npm install -g npm@latest'
            - restore_cache:
                key: dependency-cache-{{checksum "package.json"}}
            - run:
                name: install-npm
                command: npm install
            - save_cache:
                key: dependency-cache-{{checksum "package.json"}}
                paths:
                    - ./node_modules
           # Download and cache dependencies
           - restore_cache:
             keys:
               - v1-dependencies-{{ checksum "package.json" }}
               # fallback to using the latest cache if no exact match is found
               - v1-dependencies-
    
          # clearing the cache
          - run: npm cache clear --force
          # - run: rm package-lock.json
          - run: npm install
          - save_cache:
            paths:
              - node_modules
            key: v1-dependencies-{{ checksum "package.json" }}
          # run tests!
          - run: npm run test
          # build the docker image on success
          - run:
            name: Build Success
            when: on_success
            command: |
              docker --version
              docker login -u=$DOCKER_LOGIN -p=$DOCKER_PASSWORD
              docker build -t gurushishyan/gurushishyan:$CIRCLE_BRANCH --build-arg MACHINE_NAME=<application_name>-$CIRCLE_BRANCH .
              docker push gurushishyan/gurushishyan:$CIRCLE_BRANCH
              echo "Docker build made sucessfully!! for <application_name> $CIRCLE_BRANCH"
          - run:
            name: Build Failure
            when: on_fail
            command: |
              echo "ERROR building <application_name> $CIRCLE_BRANCH"